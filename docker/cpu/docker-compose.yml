name: zipvoice-tts-cpu
services:
  zipvoice-tts:
    # image: ghcr.io/fabul8/zipvoice-fastapi-cpu:v${VERSION}
    build:
      context: ../..
      dockerfile: docker/cpu/Dockerfile
    volumes:
      - ../../api:/app/api
      - zipvoice_cache:/app/api/src/voices/zipvoice_prompts
      - onnx_cache:/app/api/src/models/onnx_cache
      - temp_files:/app/api/temp_files
    user: "1000:1000"  # Ensure container runs as UID 1000 (zipvoice user)
    ports:
      - "8880:8880"
    environment:
      # Core settings
      - PYTHONPATH=/app:/app/api
      - PYTHONUNBUFFERED=1
      - API_LOG_LEVEL=INFO

      # Device settings
      - USE_GPU=false
      - DEVICE_TYPE=cpu

      # Backend settings
      - ENABLE_KOKORO=false
      - ENABLE_ZIPVOICE=true
      - DEFAULT_BACKEND=zipvoice

      # ZipVoice core settings (CPU-optimized)
      - ZIPVOICE_MODEL=zipvoice_distill  # Use distilled model for better CPU performance
      - ZIPVOICE_NUM_STEPS=4  # Lower steps for CPU (faster but lower quality)
      - ZIPVOICE_REMOVE_LONG_SILENCE=true
      - ZIPVOICE_SPEED_MULTIPLIER=1.0
      - ZIPVOICE_MAX_PROMPT_DURATION=3.0
      - ZIPVOICE_ALLOW_URL_DOWNLOAD=true
      - ZIPVOICE_ALLOW_BASE64=true
      - ZIPVOICE_MAX_DOWNLOAD_SIZE_MB=10.0

      # Smart features (CPU-optimized)
      - ENABLE_AUTO_TRANSCRIPTION=true
      - WHISPER_MODEL_SIZE=tiny  # Use tiny model for CPU efficiency
      - ENABLE_SMART_TUNING=true
      - ENABLE_QUALITY_DETECTION=true
      - QUALITY_THRESHOLD=0.7

      # Optimization settings
      - ENABLE_ONNX=false  # Can enable for some speedup on CPU
      - ENABLE_TENSORRT=false  # Not available on CPU

      # ONNX Runtime CPU optimization settings
      - ONNX_NUM_THREADS=8  # Maximize core usage for vectorized ops
      - ONNX_INTER_OP_THREADS=4  # Parallel matrix operations
      - ONNX_EXECUTION_MODE=parallel
      - ONNX_OPTIMIZATION_LEVEL=all
      - ONNX_MEMORY_PATTERN=true
      - ONNX_ARENA_EXTEND_STRATEGY=kNextPowerOfTwo

      # Paths
      - ZIPVOICE_CACHE_DIR=/app/api/src/voices/zipvoice_prompts
      - ONNX_CACHE_DIR=/app/api/src/models/onnx_cache

    healthcheck:
      test: ["CMD", "./healthcheck.sh"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

volumes:
  zipvoice_cache:
  onnx_cache:
  temp_files:
